<!doctype html>
<html lang="ne">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HealthGuide Nepal ‚Äì Health Tech Demo</title>
  <meta name="description" content="A simple, semantic health guidance web app for Nepal. Includes Nepali symptom checker, emergency contacts, and hospital map." />

  <!-- Leaflet Map CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root{
      --bg:#0b1020;           /* deep blue for trust */
      --panel:#111830;        /* card bg */
      --ink:#e7efff;          /* light text */
      --muted:#a5b4d6;        /* secondary */
      --accent:#3ddc97;       /* green */
      --danger:#ff5a5f;       /* red */
      --warn:#ffb703;         /* amber */
      --ok:#22c55e;           /* green */
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --radius: 18px;
    }
    html,body{height:100%;}
    body{
      margin:0; background:linear-gradient(180deg,#0b1020 0%, #0f1630 100%);
      color:var(--ink); font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Color Emoji', 'Apple Color Emoji', sans-serif;
    }
    a{color:var(--accent)} a:hover{opacity:.9}
    header{
      position:sticky; top:0; z-index:10; backdrop-filter:saturate(120%) blur(4px);
      background:rgba(11,16,32,.75); border-bottom:1px solid rgba(255,255,255,.06);
    }
    .wrap{max-width:1100px; margin-inline:auto; padding:18px;}
    nav{display:flex; gap:16px; align-items:center; justify-content:space-between;}
    nav .brand{display:flex; gap:12px; align-items:center;}
    .logo{width:36px; height:36px; border-radius:8px; background:conic-gradient(from 120deg, var(--accent), #6ee7b7, #06b6d4); box-shadow:var(--shadow)}
    .brand-title{font-weight:800; letter-spacing:.2px}
    .grid{display:grid; gap:18px; grid-template-columns: 1.2fr 1fr;}
    @media (max-width: 920px){ .grid{ grid-template-columns:1fr; } }

    section{ background:var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow);}
    section > header{ position:static; background:none; border:0; padding:18px 18px 0 18px }
    h1,h2,h3{ line-height:1.2; margin:0 }
    h2{ font-size:1.3rem }
    p{color:var(--muted)}

    /* Cards */
    .card{ padding:18px }

    /* Form */
    form{ display:grid; gap:12px }
    label{ font-weight:600 }
    textarea{ resize:vertical; min-height:92px; border-radius:14px; border:1px solid rgba(255,255,255,.08); background:#0b1228; color:var(--ink); padding:12px 14px }
    input[type="text"], select{ border-radius:12px; border:1px solid rgba(255,255,255,.08); background:#0b1228; color:var(--ink); padding:10px 12px }
    .row{ display:flex; gap:12px; flex-wrap:wrap }

    /* Buttons */
    .btn{ appearance:none; border:0; border-radius:14px; padding:12px 16px; font-weight:700; cursor:pointer; box-shadow:var(--shadow);}
    .btn-primary{ background:var(--accent); color:#0a0f20 }
    .btn-ghost{ background:transparent; color:var(--ink); border:1px solid rgba(255,255,255,.1) }
    .btn-danger{ background:var(--danger); color:white }
    .btn-warning{ background:var(--warn); color:#0a0f20 }
    .btn:disabled{ opacity:.6; cursor:not-allowed }

    .badge{ display:inline-block; padding:6px 10px; border-radius:999px; font-weight:700; font-size:.8rem }
    .badge.ok{ background:rgba(34,197,94,.15); color:var(--ok); border:1px solid rgba(34,197,94,.35)}
    .badge.warn{ background:rgba(255,183,3,.15); color:var(--warn); border:1px solid rgba(255,183,3,.35)}
    .badge.danger{ background:rgba(255,90,95,.15); color:var(--danger); border:1px solid rgba(255,90,95,.35)}

    /* Layout specifics */
    #map{ height:420px; border-radius:14px; overflow:hidden; border:1px solid rgba(255,255,255,.08) }
    .hlist{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .list{ display:grid; gap:10px }
    .list article{ padding:12px; border-radius:12px; background:#0c142c; border:1px solid rgba(255,255,255,.06) }
    .small{ font-size:.92rem }
    .muted{ color:var(--muted) }
    .foot{ color:#97a1c6; font-size:.9rem }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0 }
  </style>
</head>
<body>
  <header role="banner">
    <div class="wrap">
      <nav aria-label="Primary">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <div class="brand-title">HealthGuide Nepal</div>
            <small class="muted">Simple guidance ‚Ä¢ Hospital map ‚Ä¢ Emergency contacts</small>
          </div>
        </div>
        <div class="hlist" role="group" aria-label="Quick actions">
          <a class="btn btn-ghost" href="#checker">Symptoms</a>
          <a class="btn btn-ghost" href="#mapwrap">Hospitals</a>
          <button class="btn btn-danger" id="callAmbulance" aria-label="Call Ambulance (Nepal)">Call Ambulance</button>
        </div>
      </nav>
    </div>
  </header>

  <main id="main" class="wrap" role="main">
    <div class="grid" aria-describedby="app-desc">
      <!-- Symptom Checker -->
      <section id="checker" aria-labelledby="checker-title">
        <header class="card">
          <h2 id="checker-title">ü§í Nepali Symptom Checker (Rule‚Äëbased)</h2>
          <p id="app-desc">Type symptoms in Nepali or English. This is not a diagnosis‚Äîjust simple guidance to help you decide next steps.</p>
        </header>
        <div class="card">
          <form id="symptomForm" aria-describedby="disclaimer">
            <label for="symptoms">‡§≤‡§ï‡•ç‡§∑‡§£ (Symptoms)</label>
            <textarea id="symptoms" name="symptoms" placeholder="‡§â‡§¶‡§æ‡§π‡§∞‡§£: ‡§ú‡•ç‡§µ‡§∞‡•ã, ‡§ü‡§æ‡§â‡§ï‡•ã ‡§¶‡•Å‡§ñ‡§æ‡§á, ‡§ñ‡•ã‡§ï‡•Ä, ‡§∏‡§æ‡§∏ ‡§´‡•á‡§∞‡•ç‡§® ‡§ó‡§æ‡§π‡•ç‡§∞‡•ã‚Ä¶" required></textarea>

            <div class="row" aria-label="Options">
              <label class="sr-only" for="age">Age group</label>
              <select id="age" name="age">
                <option value="adult">Adult</option>
                <option value="child">Child</option>
                <option value="elder">Elderly</option>
              </select>

              <label class="sr-only" for="duration">Duration</label>
              <input id="duration" name="duration" type="text" inputmode="numeric" placeholder="Duration (days)" />

              <button type="submit" class="btn btn-primary">Get Guidance</button>
              <button type="reset" class="btn btn-ghost" id="clear">Clear</button>
            </div>

            <p id="disclaimer" class="small muted">Disclaimer: Educational only. For emergencies, call an ambulance or visit the nearest hospital.</p>
          </form>

          <output id="result" aria-live="polite" aria-atomic="true"></output>
        </div>
      </section>

      <!-- Map & Hospitals -->
      <section id="mapwrap" aria-labelledby="map-title">
        <header class="card">
          <h2 id="map-title">üè• Nearby Hospitals & Clinics</h2>
          <p>Allow location to see distance. Markers are sample data; replace or extend for your district.</p>
        </header>
        <div class="card">
          <div id="map" role="region" aria-label="Hospital map of Nepal"></div>
          <div class="list" aria-label="Hospital list" style="margin-top:12px" id="hospitalList"></div>
        </div>
      </section>
    </div>

    <!-- Emergency & Info -->
    <section aria-labelledby="emg-title" style="margin-top:18px">
      <header class="card">
        <h2 id="emg-title">üöë Emergency Contacts (Nepal)</h2>
      </header>
      <div class="card hlist">
        <!-- Common national numbers; confirm locally and customize if needed. -->
        <a class="btn btn-danger" href="tel:102" aria-label="Dial 102 for Ambulance">102 Ambulance</a>
        <a class="btn btn-warning" href="tel:100" aria-label="Dial 100 for Police">100 Police</a>
        <a class="btn btn-warning" href="tel:101" aria-label="Dial 101 for Fire">101 Fire</a>
        <button class="btn btn-ghost" id="copyEmg">Copy all numbers</button>
        <span id="copyState" class="small muted" role="status" aria-live="polite"></span>
      </div>
    </section>

    <aside class="foot wrap" aria-label="App info" style="padding-left:0">
      <p><strong>How the guidance works:</strong> keyword matching (Nepali & English synonyms), basic risk rules (age, duration, red‚Äëflag signs). Highest risk wins. Everything runs locally in your browser‚Äîno data leaves your device.</p>
    </aside>
  </main>

  <footer class="wrap" role="contentinfo" style="opacity:.9; padding-bottom:48px">
    <p>¬© <span id="year"></span> HealthGuide Nepal ‚Äî Demo for hackathon. Built with semantic HTML, accessible components, Leaflet maps, and human‚Äëwritten rules. Replace sample data before production.</p>
  </footer>

  <!-- Leaflet Map JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // Utilities
    const $ = (sel, parent=document) => parent.querySelector(sel);
    const $$ = (sel, parent=document) => [...parent.querySelectorAll(sel)];

    // ---- Symptom Logic (human-made rules) ----
    /**
     * Each rule has: keywords (Nepali & English), advice, urgency (0 ok, 1 warn, 2 danger)
     * Some rules add redFlag if certain phrases are found
     */
    const RULES = [
      {
        id:'breathing',
        keywords:['‡§∏‡§æ‡§∏ ‡§´‡•á‡§∞‡•ç‡§® ‡§ó‡§æ‡§π‡•ç‡§∞‡•ã','‡§∏‡§æ‡§∏ ‡§´‡•á‡§∞‡•ç‡§®','‡§¶‡§Æ','breathless','shortness of breath','difficulty breathing'],
        advice:'‡§§‡•Å‡§∞‡•Å‡§®‡•ç‡§§ ‡§®‡§ú‡§ø‡§ï‡§ï‡•ã ‡§Ö‡§∏‡•ç‡§™‡§§‡§æ‡§≤ ‡§ú‡§æ‡§®‡•Å‡§π‡•ã‡§∏‡•ç ‡§µ‡§æ ‡§è‡§Æ‡•ç‡§¨‡•Å‡§≤‡•á‡§®‡•ç‡§∏ ‡§¨‡•ã‡§≤‡§æ‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§ ‡§∏‡§æ‡§∏ ‡§´‡•á‡§∞‡•ç‡§® ‡§ó‡§æ‡§π‡•ç‡§∞‡•ã ‡§π‡•Å‡§®‡•Å ‡§Ü‡§™‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§∏‡§Ç‡§ï‡•á‡§§ ‡§π‡•ã‡•§',
        urgency:2
      },
      {
        id:'chestPain',
        keywords:['‡§õ‡§æ‡§§‡•Ä ‡§¶‡•Å‡§ñ‡§æ‡§á','‡§õ‡§æ‡§§‡•Ä ‡§™‡•ã‡§≤','heart pain','chest pain','pressure chest'],
        advice:'‡§Ø‡§¶‡§ø ‡§õ‡§æ‡§§‡•Ä ‡§¶‡•Å‡§ñ‡§æ‡§á ‡§®‡§Ø‡§æ‡§Å ‡§õ ‡§µ‡§æ ‡§™‡§∏‡§ø‡§®‡§æ/‡§¨‡§æ‡§®‡•ç‡§§‡§æ/‡§∏‡§æ‡§∏ ‡§´‡•á‡§∞‡•ç‡§® ‡§ó‡§æ‡§π‡•ç‡§∞‡•ã‡§∏‡§Å‡§ó‡•à ‡§õ ‡§≠‡§®‡•á ‡§§‡•Å‡§∞‡•Å‡§®‡•ç‡§§ ‡§à‡§Ü‡§∞ ‡§ú‡§æ‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§',
        urgency:2
      },
      {
        id:'fever',
        keywords:['‡§ú‡•ç‡§µ‡§∞‡•ã','‡§§‡§æ‡§™','fever','temperature'],
        advice:'‡§ß‡•á‡§∞‡•à ‡§™‡§æ‡§®‡•Ä ‡§™‡§ø‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç, ‡§Ü‡§∞‡§æ‡§Æ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç, ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§™‡§∞‡•á ‡§™‡§æ‡§∞‡§æ‡§∏‡§ø‡§ü‡§æ‡§Æ‡•ã‡§≤ (‡§°‡§æ‡§ï‡•ç‡§ü‡§∞‡§ï‡•ã ‡§∏‡§≤‡•ç‡§≤‡§æ‡§π ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞) ‡§≤‡§ø‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§ ‡•© ‡§¶‡§ø‡§® ‡§≠‡§®‡•ç‡§¶‡§æ ‡§¨‡§¢‡•Ä ‡§ü‡§ø‡§ï‡•á ‡§µ‡§æ ‡§ß‡•á‡§∞‡•à ‡§â‡§ö‡•ç‡§ö ‡§≠‡§è ‡§ú‡§æ‡§Å‡§ö ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§',
        urgency:1,
        refine: ({durationDays}) => durationDays >= 3 ? 1 : 0 // bump if prolonged
      },
      {
        id:'cough',
        keywords:['‡§ñ‡•ã‡§ï‡•Ä','‡§ï‡§´','‡§∞‡•Å‡§ò‡§æ','cough','cold'],
        advice:'‡§§‡§æ‡§§‡•ã ‡§™‡§æ‡§®‡•Ä, ‡§µ‡§ø‡§∂‡•ç‡§∞‡§æ‡§Æ, ‡§∞ ‡§Æ‡§π/‡§Ö‡§¶‡•Å‡§µ‡§æ‡§ï‡•ã ‡§ù‡•ã‡§≤ ‡§â‡§™‡§Ø‡•ã‡§ó‡•Ä‡•§ ‡§∏‡§æ‡§∏ ‡§´‡•á‡§∞‡•ç‡§® ‡§ó‡§æ‡§π‡•ç‡§∞‡•ã, ‡§õ‡§æ‡§§‡•Ä ‡§¶‡•Å‡§ñ‡•ç‡§®‡•á ‡§µ‡§æ ‡§∞‡§ó‡§§ ‡§Ü‡§è‡§ï‡•ã ‡§ñ‡•ã‡§ï‡•Ä ‡§≠‡§è ‡§ú‡§æ‡§Å‡§ö‡•§',
        urgency:0
      },
      {
        id:'headache',
        keywords:['‡§ü‡§æ‡§â‡§ï‡•ã ‡§¶‡•Å‡§ñ‡§æ‡§á','headache','migraine'],
        advice:'‡§™‡§æ‡§®‡•Ä ‡§™‡§ø‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç, ‡§™‡§∞‡•ç‡§Ø‡§æ‡§™‡•ç‡§§ ‡§®‡§ø‡§¶‡•ç‡§∞‡§æ ‡§≤‡§ø‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§ ‡§∏‡§¨‡•à‡§≠‡§®‡•ç‡§¶‡§æ ‡§ñ‡§∞‡§æ‡§¨ ‡§ü‡§æ‡§á‡§™‡§ï‡•ã ‡§ü‡§æ‡§â‡§ï‡•ã ‡§¶‡•Å‡§ñ‡§æ‡§á, ‡§ó‡§≤‡•ç‡§≤‡•Ä ‡§ï‡§°‡§ø‡§®‡•Å, ‡§â‡§ö‡•ç‡§ö ‡§ú‡•ç‡§µ‡§∞‡•ã ‡§µ‡§æ ‡§¨‡•á‡§π‡•ã‡§∏‡§™‡§®‡§æ‡§∏‡§Å‡§ó ‡§õ ‡§≠‡§®‡•á ‡§§‡•Å‡§∞‡•Å‡§®‡•ç‡§§ ‡§ú‡§æ‡§Å‡§ö‡•§',
        urgency:0
      },
      {
        id:'vomit',
        keywords:['‡§µ‡§æ‡§®‡•ç‡§§‡§æ','‡§â‡§≤‡•ç‡§ü‡§ø','‡§¨‡§æ‡§®‡•ç‡§§‡§æ','vomit','nausea',' ‡§â‡§≤‡•ç‡§ü‡•Ä'],
        advice:'‡§∏‡§æ‡§®‡•ã‚Äë‡§∏‡§æ‡§®‡•ã ‡§ò‡§æ‡§Å‡§∏‡•à ‡§™‡§æ‡§®‡•Ä/ORS ‡§™‡§ø‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§ ‡§ß‡•á‡§∞‡•à ‡§¨‡§æ‡§∞‡§Æ‡•ç‡§¨‡§æ‡§∞ ‡§µ‡§æ ‡§∞‡§ó‡§§ ‡§™‡§∞‡•á‡§ï‡•ã ‡§õ ‡§≠‡§®‡•á ‡§Ü‡§™‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§∏‡•á‡§µ‡§æ ‡§ñ‡•ã‡§ú‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§',
        urgency:1
      },
      {
        id:'diarrhea',
        keywords:['‡§™‡§ñ‡§æ‡§≤‡§æ','‡§¶‡§ø‡§Å‡§π‡§æ','diarrhea','loose motion'],
        advice:'ORS, ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§™‡§æ‡§®‡•Ä, ‡§∏‡§´‡§æ ‡§ñ‡§æ‡§®‡§æ‡•§ ‡§â‡§ö‡•ç‡§ö ‡§ú‡•ç‡§µ‡§∞‡•ã/‡§∞‡§ó‡§§/‡§°‡§ø‡§π‡§æ‡§á‡§°‡•ç‡§∞‡•á‡§∂‡§® (‡§∏‡•Å‡§ñ‡•ç‡§ñ‡§æ ‡§ú‡§ø‡§¨‡•ç‡§∞‡•ã, ‡§ï‡§Æ ‡§™‡§ø‡§∏‡§æ‡§¨) ‡§≠‡§è ‡§Ö‡§∏‡•ç‡§™‡§§‡§æ‡§≤ ‡§ú‡§æ‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§',
        urgency:1
      },
      {
        id:'injury',
        keywords:['‡§ö‡•ã‡§ü','‡§≤‡§æ‡§ó‡•ç‡§Ø‡•ã','‡§ò‡§æ‡§â','injury','fracture','bleeding'],
        advice:'‡§∞‡§ó‡§§ ‡§¨‡§ó‡§ø‡§∞‡§π‡•á‡§ï‡•ã ‡§õ ‡§≠‡§®‡•á ‡§•‡§ø‡§ö‡•á‡§∞ ‡§•‡§æ‡§Æ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§ ‡§ó‡§Æ‡•ç‡§≠‡•Ä‡§∞ ‡§ö‡•ã‡§ü/‡§π‡§°‡•ç‡§°‡•Ä ‡§≠‡§æ‡§Å‡§ö‡§ø‡§è‡§ï‡•ã ‡§∂‡§Ç‡§ï‡§æ ‡§≠‡§è ‡§§‡•Å‡§∞‡•Å‡§®‡•ç‡§§ ‡§Ö‡§∏‡•ç‡§™‡§§‡§æ‡§≤‡•§',
        urgency:2
      },
      {
        id:'pregnancy',
        keywords:['‡§ó‡§∞‡•ç‡§≠','‡§ó‡§∞‡•ç‡§≠‡§µ‡§§‡•Ä','pregnant','‡§ó‡§∞‡•ç‡§≠‡§æ‡§ß‡§æ‡§®','pregnancy'],
        advice:'‡§¢‡§ø‡§≤‡§æ ‡§®‡§ó‡§∞‡•Ä ‡§™‡•ç‡§∞‡§∏‡•Ç‡§§‡§ø ‡§∏‡§≤‡•ç‡§≤‡§æ‡§π ‡§ï‡•á‡§®‡•ç‡§¶‡•ç‡§∞/‡§Ö‡§∏‡•ç‡§™‡§§‡§æ‡§≤‡§Æ‡§æ ‡§∏‡§Æ‡•ç‡§™‡§∞‡•ç‡§ï ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§ ‡§™‡•á‡§ü ‡§ï‡§°‡§ø‡§®‡•Å, ‡§∞‡§ó‡§§ ‡§¨‡§ó‡•ç‡§®‡•Å ‡§µ‡§æ ‡§∂‡§ø‡§∂‡•Å ‡§®‡§ö‡§≤‡•ç‡§®‡•Å ‡§Ü‡§™‡§§‡§ï‡§æ‡§≤ ‡§π‡•ã‡•§',
        urgency:1
      },
      {
        id:'hypertension',
        keywords:['‡§™‡•ç‡§∞‡•á‡§∂‡§∞','‡§¨‡•ç‡§≤‡§° ‡§™‡•ç‡§∞‡•á‡§∏‡§∞','blood pressure','hypertension','bp high'],
        advice:'‡§Ü‡§∞‡§æ‡§Æ, ‡§®‡•Å‡§® ‡§ï‡§Æ, ‡§®‡§ø‡§Ø‡§Æ‡§ø‡§§ ‡§î‡§∑‡§ß‡§ø‡•§ ‡§§‡•Ä‡§µ‡•ç‡§∞ ‡§ü‡§æ‡§â‡§ï‡•ã ‡§¶‡•Å‡§ñ‡§æ‡§á/‡§õ‡§æ‡§§‡•Ä ‡§¶‡•Å‡§ñ‡§æ‡§á/‡§ß‡•Å‡§®‡•ç‡§¶‡•ã ‡§¶‡•á‡§ñ‡§æ‡§á ‡§≠‡§è ‡§à‡§Ü‡§∞‡•§',
        urgency:1
      }
    ];

    const RED_FLAGS = [
      { words:['‡§∞‡§ó‡§§','blood','bloody'], note:'‡§∞‡§ó‡§§ ‡§¶‡•á‡§ñ‡§æ ‡§™‡§∞‡•á‡§ï‡•ã ‡§õ ‚Äî ‡§ó‡§Æ‡•ç‡§≠‡•Ä‡§∞ ‡§π‡•Å‡§® ‡§∏‡§ï‡•ç‡§õ‡•§', bump:2 },
      { words:['‡§¨‡•á‡§π‡•ã‡§∏','‡§ö‡§ï‡•ç‡§ï‡§∞ ‡§ß‡•á‡§∞‡•à','faint','unconscious'], note:'‡§¨‡•á‡§π‡•ã‡§∏ ‡§µ‡§æ ‡§ß‡•á‡§∞‡•à ‡§ö‡§ï‡•ç‡§ï‡§∞ ‚Äî ‡§Ü‡§™‡§§‡§ï‡§æ‡§≤‡•§', bump:2 },
      { words:['‡§§‡•Ä‡§µ‡•ç‡§∞ ‡§¶‡•Å‡§ñ‡§æ‡§á','extreme pain','severe pain'], note:'‡§Ö‡§§‡•ç‡§Ø‡§æ‡§ß‡§ø‡§ï ‡§¶‡•Å‡§ñ‡§æ‡§á ‚Äî ‡§â‡§ö‡•ç‡§ö ‡§™‡•ç‡§∞‡§æ‡§•‡§Æ‡§ø‡§ï‡§§‡§æ‡•§', bump:1 }
    ];

    function normalize(text){
      return (text||'').toLowerCase().replace(/[\s\n\t]+/g,' ').trim();
    }

    function parseDuration(daysStr){
      const n = parseFloat(daysStr?.replace(/[^0-9.]/g,''));
      return Number.isFinite(n) ? n : 0;
    }

    function evaluateSymptoms(input, ctx){
      const text = normalize(input);
      let best = { urgency: -1, rule: null };
      const matched = [];

      for(const rule of RULES){
        const hit = rule.keywords.some(k => text.includes(k.toLowerCase()));
        if(hit){
          let u = rule.urgency;
          if(typeof rule.refine === 'function'){
            u += rule.refine(ctx) || 0;
          }
          matched.push(rule.id);
          if(u > best.urgency){ best = { urgency: u, rule } }
        }
      }

      // Red flags bump
      const redNotes = [];
      for(const rf of RED_FLAGS){
        if(rf.words.some(w => text.includes(w.toLowerCase()))){
          best.urgency = Math.max(best.urgency, 0) + rf.bump; // ensure non-negative then bump
          redNotes.push(rf.note);
        }
      }

      // Age-specific bump (children & elders slightly higher risk)
      if(ctx.age !== 'adult' && best.urgency >= 0){ best.urgency += 1 }

      // Cap urgency between 0..3
      best.urgency = Math.max(0, Math.min(3, best.urgency));

      return { best, matched, redNotes };
    }

    function renderResult(evaluation){
      const out = $('#result');
      if(!evaluation.best.rule){
        out.innerHTML = `<article class="list"><div>üôã‚Äç‚ôÄÔ∏è <strong>We could not find a specific match.</strong> Try simpler words like <em>‡§ú‡•ç‡§µ‡§∞‡•ã</em>, <em>‡§ñ‡•ã‡§ï‡•Ä</em>, <em>‡§õ‡§æ‡§§‡•Ä ‡§¶‡•Å‡§ñ‡§æ‡§á</em>, <em>‡§µ‡§æ‡§®‡•ç‡§§‡§æ</em> ‚Ä¶ If you feel unsafe, please visit the nearest hospital.</div></article>`;
        return;
      }

      const { best, redNotes } = evaluation;
      const level = best.urgency >= 3 ? 'danger' : best.urgency >= 2 ? 'danger' : best.urgency === 1 ? 'warn' : 'ok';
      const title = best.rule.id.replace(/(^|_)([a-z])/g, (_,p2,c)=> (p2?' ':'')+c.toUpperCase());

      const tips = {
        ok: '‡§ò‡§∞‡§Æ‡•à ‡§®‡§ø‡§ó‡§∞‡§æ‡§®‡•Ä ‡§∞‡§æ‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§ ‡§≤‡§ï‡•ç‡§∑‡§£ ‡§¨‡§¢‡•á‡§Æ‡§æ ‡§µ‡§æ ‡•© ‡§¶‡§ø‡§® ‡§≠‡§ø‡§§‡•ç‡§∞ ‡§®‡§π‡§ü‡•á‡§Æ‡§æ ‡§ú‡§æ‡§Å‡§ö ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§',
        warn: '‡§Ü‡§ú‡•à ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø‡§ï‡§∞‡•ç‡§Æ‡•Ä‡§ï‡•ã ‡§∏‡§≤‡•ç‡§≤‡§æ‡§π ‡§≤‡§ø‡§®‡•Å ‡§â‡§™‡§Ø‡•Å‡§ï‡•ç‡§§ ‡§π‡•Å‡§®‡•ç‡§õ‡•§',
        danger: '‡§Ø‡•ã ‡§â‡§ö‡•ç‡§ö ‡§ú‡•ã‡§ñ‡§ø‡§Æ‡§ï‡•ã ‡§∏‡§Ç‡§ï‡•á‡§§ ‡§π‡•Å‡§® ‡§∏‡§ï‡•ç‡§õ ‚Äî ‡§®‡§ú‡§ø‡§ï‡§ï‡•ã ‡§Ö‡§∏‡•ç‡§™‡§§‡§æ‡§≤ ‡§ú‡§æ‡§®‡•Å‡§π‡•ã‡§∏‡•ç ‡§µ‡§æ ‡§è‡§Æ‡•ç‡§¨‡•Å‡§≤‡•á‡§®‡•ç‡§∏ ‡§¨‡•ã‡§≤‡§æ‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§'
      };

      out.innerHTML = `
        <article class="list" aria-label="Guidance result">
          <div class="hlist">
            <span class="badge ${level}">Priority: ${level.toUpperCase()}</span>
            <strong>${title}</strong>
          </div>
          <p>${best.rule.advice}</p>
          ${redNotes.length? `<p><strong>Red flags:</strong> ${redNotes.join(' ‚Ä¢ ')}</p>`:''}
          <p class="muted">${tips[level]}</p>
          <div class="hlist">
            <a class="btn btn-primary" href="#mapwrap">Find Hospital</a>
            <a class="btn btn-danger" href="tel:102">Call Ambulance 102</a>
          </div>
        </article>`;

      // Save to local history
      try{
        const history = JSON.parse(localStorage.getItem('hg_history')||'[]');
        history.unshift({ when: new Date().toISOString(), urgency: level, rule: best.rule.id });
        localStorage.setItem('hg_history', JSON.stringify(history.slice(0,20)));
      }catch(e){}
    }

    $('#symptomForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const symptoms = $('#symptoms').value;
      const age = $('#age').value;
      const durationDays = parseDuration($('#duration').value);
      const evaluation = evaluateSymptoms(symptoms, {age, durationDays});
      renderResult(evaluation);
    });

    $('#clear').addEventListener('click', ()=>{ $('#result').innerHTML=''; });
    $('#year').textContent = new Date().getFullYear();

    // ---- Emergency helpers ----
    $('#callAmbulance').addEventListener('click', ()=>{ window.location.href = 'tel:102'; });
    $('#copyEmg').addEventListener('click', async ()=>{
      const text = 'Ambulance: 102\nPolice: 100\nFire: 101';
      try{ await navigator.clipboard.writeText(text); $('#copyState').textContent='Copied ‚úì'; }
      catch{ $('#copyState').textContent='Copy failed'; }
      setTimeout(()=> $('#copyState').textContent='', 3000);
    });

    // ---- Map logic ----
    const HOSPITALS = [
      { name:'Bir Hospital, Kathmandu', lat:27.7056, lng:85.3147, phone:'+977-1-4221119' },
      { name:'Patan Hospital, Lalitpur', lat:27.6739, lng:85.3250, phone:'+977-1-5522295' },
      { name:'KMC Teaching Hospital, Kathmandu', lat:27.7140, lng:85.3150, phone:'+977-1-4476152' },
      { name:'BPKIHS, Dharan', lat:26.8090, lng:87.2840, phone:'+977-25-525555' },
      { name:'Gandaki Medical College, Pokhara', lat:28.2090, lng:83.9880, phone:'+977-61-522555' },
      { name:'Bharatpur Hospital, Chitwan', lat:27.6773, lng:84.4359, phone:'+977-56-520178' }
    ];

    const map = L.map('map');
    const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // Initial view over Nepal
    map.setView([28.3949, 84.1240], 7);

    function kmDistance(a, b){
      const toRad = d => d * Math.PI/180;
      const R = 6371; // km
      const dLat = toRad(b.lat - a.lat);
      const dLng = toRad(b.lng - a.lng);
      const s1 = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
      return 2 * R * Math.asin(Math.sqrt(s1));
    }

    // Add markers
    const markers = HOSPITALS.map(h => {
      const m = L.marker([h.lat, h.lng]).addTo(map);
      m.bindPopup(`<strong>${h.name}</strong><br><a href="tel:${h.phone.replace(/[^+0-9]/g,'')}">Call</a>`);
      return {...h, marker:m };
    });

    function renderHospitalList(user){
      const wrap = $('#hospitalList');
      const withDist = markers.map(h => {
        const d = user ? kmDistance(user, h) : null;
        return {...h, dist:d };
      }).sort((a,b)=> (a.dist??9999) - (b.dist??9999));

      wrap.innerHTML = withDist.map(h => `
        <article>
          <div class="hlist" style="justify-content:space-between">
            <div>
              <strong>${h.name}</strong><br>
              <span class="muted small">${h.dist? h.dist.toFixed(1)+' km':''}</span>
            </div>
            <div class="hlist">
              ${h.dist!=null? `<span class="badge ok">Nearest</span>`:''}
              <a class="btn btn-primary" href="tel:${h.phone.replace(/[^+0-9]/g,'')}">Call</a>
              <button class="btn btn-ghost" onclick="window.scrollTo({top:document.getElementById('map').offsetTop-80,behavior:'smooth'}); markers.find(x=>x.name==='${h.name}').marker.openPopup();">Open on Map</button>
            </div>
          </div>
        </article>`).join('');
    }

    renderHospitalList(null);

    // Geolocate user
    if('geolocation' in navigator){
      navigator.geolocation.getCurrentPosition(pos=>{
        const user = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        const you = L.circleMarker([user.lat, user.lng], { radius:8 }).addTo(map).bindPopup('You are here');
        map.setView([user.lat, user.lng], 12);
        renderHospitalList(user);
      }, err=>{
        console.info('Geolocation denied', err);
      })
    }
  </script>
</body>
</html>
